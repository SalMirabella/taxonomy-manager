<!-- Query Builder Component -->
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  
  <!-- Header -->
  <header class="bg-black/30 backdrop-blur border-b border-white/10 px-4 py-3 sticky top-0 z-50">
    <div class="max-w-5xl mx-auto">
      
      <!-- Title -->
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-lg font-bold">üî¨ Query Builder</h1>
        <button 
          *ngIf="query.length > 0 || selected"
          (click)="clearAll()"
          class="text-xs bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg hover:bg-red-500/30">
          ‚úï Reset
        </button>
      </div>

      <!-- Search -->
      <div class="relative" #dropdownRef>
        <input
          #searchInput
          type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()"
          (focus)="onSearchFocus()"
          placeholder="Search diseases, symptoms, vectors, hosts, hazards..."
          class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2.5 outline-none focus:border-indigo-500 placeholder-slate-400"
        />

        <!-- Dropdown -->
        <div 
          *ngIf="showDropdown && searchResults.length > 0"
          class="absolute z-50 w-full mt-2 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-h-96 overflow-y-auto">
          
          <ng-container *ngFor="let item of searchResults">
            <!-- Header -->
            <div 
              *ngIf="isHeader(item)"
              class="px-3 py-2 text-sm font-bold bg-indigo-600 sticky top-0">
              {{ typeConfig[item.type]?.icon }} {{ item.label }}
            </div>

            <!-- Category (collapsible) -->
            <ng-container *ngIf="!isHeader(item) && item.isCategory">
              <button
                (click)="toggleGroup(item.uri)"
                class="w-full px-4 py-2 text-slate-300 bg-slate-700/50 flex items-center justify-between hover:bg-slate-700 transition">
                <span class="flex items-center gap-2">
                  üìÇ {{ item.label }}
                  <span class="text-xs text-slate-500">({{ getChildren(item.uri, getDataKeyForEntity(item)).length }})</span>
                </span>
                <span class="text-slate-400">{{ isGroupExpanded(item.uri) ? '‚ñº' : '‚ñ∂' }}</span>
              </button>
              
              <!-- Children -->
              <ng-container *ngIf="isGroupExpanded(item.uri)">
                <button
                  *ngFor="let child of getChildren(item.uri, getDataKeyForEntity(item))"
                  (click)="addToQuery(child)"
                  class="w-full text-left px-6 py-2 hover:bg-slate-700 flex justify-between border-b border-slate-700/30"
                  [ngClass]="{'bg-indigo-500/20': isInQuery(child.uri)}">
                  <span class="flex items-center gap-2">
                    <span [style.color]="typeConfig[child.type]?.color">{{ typeConfig[child.type]?.icon }}</span>
                    {{ child.label }}
                  </span>
                  <span 
                    class="text-xs px-2 py-0.5 rounded"
                    [style.backgroundColor]="typeConfig[child.type]?.bg"
                    [style.color]="typeConfig[child.type]?.color">
                    {{ typeConfig[child.type]?.label }}
                  </span>
                </button>
              </ng-container>
            </ng-container>

            <!-- Regular Entity -->
            <button
              *ngIf="!isHeader(item) && !item.isCategory"
              (click)="addToQuery(item)"
              class="w-full text-left px-4 py-2 hover:bg-slate-700 flex justify-between border-b border-slate-700/30"
              [ngClass]="{'bg-indigo-500/20': isInQuery(item.uri)}">
              <span class="flex items-center gap-2">
                <span [style.color]="typeConfig[item.type]?.color">{{ typeConfig[item.type]?.icon }}</span>
                {{ item.label }}
              </span>
              <span 
                class="text-xs px-2 py-0.5 rounded"
                [style.backgroundColor]="typeConfig[item.type]?.bg"
                [style.color]="typeConfig[item.type]?.color">
                {{ typeConfig[item.type]?.label }}
              </span>
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Query Display -->
      <div *ngIf="query.length > 0" class="mt-3 space-y-2">
        
        <!-- Query Widget with Tabs -->
        <div class="bg-slate-800 rounded-lg border border-slate-600 overflow-hidden">
          
          <!-- Tab Header -->
          <div class="flex border-b border-slate-600">
            <button
              (click)="queryView = 'natural'"
              class="flex-1 px-4 py-2 text-sm font-medium transition"
              [class.bg-slate-700]="queryView === 'natural'"
              [class.text-white]="queryView === 'natural'"
              [class.text-slate-400]="queryView !== 'natural'">
              üìù Natural Language
            </button>
            <button
              (click)="queryView = 'technical'"
              class="flex-1 px-4 py-2 text-sm font-medium transition"
              [class.bg-slate-700]="queryView === 'technical'"
              [class.text-white]="queryView === 'technical'"
              [class.text-slate-400]="queryView !== 'technical'">
              üíª Technical Query
            </button>
          </div>

          <!-- Tab Content -->
          <div class="p-3">
            
            <!-- Natural Language -->
            <p *ngIf="queryView === 'natural'" class="text-slate-300 leading-relaxed">
              Select all entities that have
              <ng-container *ngFor="let group of getGroupedQuery(); let groupIdx = index">
                <span *ngIf="groupIdx > 0">, </span>
                <ng-container *ngFor="let q of group.items; let idx = index">
                  <span *ngIf="idx > 0 && idx < group.items.length - 1">, </span>
                  <span *ngIf="idx > 0 && idx === group.items.length - 1"> and </span>
                  <button
                    (click)="selectEntity(q)"
                    class="font-medium hover:underline"
                    [style.color]="typeConfig[q.type]?.color">
                    {{ q.label }}
                  </button>
                </ng-container>
                <span class="text-slate-400"> {{ getTypeLabel(group.type, group.items.length) }}</span>
              </ng-container>
              <span class="text-emerald-400 ml-1">‚Üí {{ queryResults.length }} results</span>
            </p>

            <!-- Technical -->
            <div *ngIf="queryView === 'technical'" class="font-mono text-sm">
              <span class="text-indigo-400">SELECT</span>
              <span class="text-emerald-400"> * </span>
              <span class="text-indigo-400">WHERE </span>
              <ng-container *ngFor="let q of query; let idx = index">
                <span *ngIf="idx > 0" class="text-indigo-400"> AND </span>
                <span class="text-slate-300">{{ typeConfig[q.type]?.label }}</span>
                <span class="text-slate-500"> = </span>
                <button
                  (click)="selectEntity(q)"
                  class="text-amber-400 hover:underline cursor-pointer">
                  "{{ q.label }}"
                </button>
              </ng-container>
              <span class="text-emerald-400 ml-2">‚Üí {{ queryResults.length }} results</span>
            </div>
          </div>
        </div>

        <!-- Filter Chips -->
        <div class="flex flex-wrap gap-2">
          <span
            *ngFor="let q of query"
            class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm cursor-pointer"
            [class.ring-2]="selected?.uri === q.uri"
            [class.ring-white]="selected?.uri === q.uri"
            [style.backgroundColor]="typeConfig[q.type]?.bg"
            [style.color]="typeConfig[q.type]?.color">
            <button (click)="selectEntity(q)" class="flex items-center gap-1 hover:opacity-80">
              {{ typeConfig[q.type]?.icon }} {{ q.label }}
            </button>
            <button (click)="removeFromQuery(q.uri)" class="ml-1 hover:opacity-70">‚úï</button>
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto p-4 flex gap-4">
    
    <!-- Sidebar -->
    <aside class="w-60 flex-shrink-0 space-y-2 hidden lg:block">
      <div
        *ngFor="let cat of categories"
        class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">

        <!-- Category Header (Clickable) -->
        <button
          *ngIf="getCategoryItems(cat.key).length > 0"
          (click)="toggleCategory(cat.key)"
          class="w-full px-3 py-2 flex justify-between items-center hover:opacity-90 transition"
          [style.backgroundColor]="typeConfig[getCategoryItems(cat.key)[0].type]?.bg">
          <span
            class="font-bold text-sm"
            [style.color]="typeConfig[getCategoryItems(cat.key)[0].type]?.color">
            {{ typeConfig[getCategoryItems(cat.key)[0].type]?.icon }} {{ cat.label }}
          </span>
          <div class="flex items-center gap-2">
            <span
              class="text-xs"
              [style.color]="typeConfig[getCategoryItems(cat.key)[0].type]?.color">
              {{ getSelectableCount(cat.key) }}
            </span>
            <span class="text-xs opacity-70">
              {{ isCategoryExpanded(cat.key) ? '‚ñº' : '‚ñ∂' }}
            </span>
          </div>
        </button>

        <!-- Category Content -->
        <div *ngIf="isCategoryExpanded(cat.key)" class="p-2">
          <ng-container *ngFor="let item of getCategoryItems(cat.key)">

            <!-- Subcategory -->
            <div *ngIf="item.isCategory" class="mb-2">
              <div class="flex items-center gap-1 text-xs text-slate-400 py-1 px-1">
                üìÇ {{ item.label }}
                <span class="text-slate-500">({{ getChildren(item.uri, cat.key).length }})</span>
              </div>
              <div class="ml-3 space-y-0.5">
                <button
                  *ngFor="let child of getChildren(item.uri, cat.key)"
                  (click)="addToQuery(child)"
                  [ngClass]="{
                    'w-full text-left text-xs px-2 py-1 rounded transition': true,
                    'hover:bg-slate-700/30': true,
                    'bg-slate-700 bg-opacity-50 font-semibold': isInQuery(child.uri),
                    'ring-1 ring-white ring-opacity-50': selected?.uri === child.uri
                  }"
                  [style.color]="typeConfig[child.type]?.color">
                  {{ child.label }}
                </button>
              </div>
            </div>

            <!-- Standalone Entity -->
            <button
              *ngIf="!item.isCategory && !item.parent"
              (click)="addToQuery(item)"
              [ngClass]="{
                'w-full text-left text-xs px-2 py-1 rounded transition mb-0.5': true,
                'hover:bg-slate-700/30': true,
                'bg-slate-700 bg-opacity-50 font-semibold': isInQuery(item.uri),
                'ring-1 ring-white ring-opacity-50': selected?.uri === item.uri
              }"
              [style.color]="typeConfig[item.type]?.color">
              {{ item.label }}
            </button>
          </ng-container>
        </div>
      </div>
    </aside>

    <!-- Main Panel -->
    <div class="flex-1 space-y-4">
      
      <!-- Entity Detail Panel (Collapsible) -->
      <div
        *ngIf="selected"
        class="bg-slate-800/50 rounded-xl border overflow-hidden"
        [style.borderColor]="getSelectedConfig()?.color + '50'">
        
        <!-- Header (clickable to toggle) -->
        <button
          (click)="detailOpen = !detailOpen"
          class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition"
          [style.backgroundColor]="getSelectedConfig()?.bg">
          <h3
            class="font-bold text-lg flex items-center gap-2"
            [style.color]="getSelectedConfig()?.color">
            {{ getSelectedConfig()?.icon }} {{ selected.label }}
            <span class="text-sm font-normal opacity-70">({{ getSelectedConfig()?.label }})</span>
          </h3>
          <div class="flex items-center gap-2">
            <span
              *ngIf="isInQuery(selected.uri)"
              (click)="$event.stopPropagation(); removeFromQuery(selected.uri)"
              class="text-xs px-2 py-1 rounded bg-white/20 hover:bg-white/30 cursor-pointer"
              [style.color]="getSelectedConfig()?.color">
              Remove from query
            </span>
            <span
              (click)="$event.stopPropagation(); selected = null"
              class="opacity-70 hover:opacity-100 text-lg cursor-pointer">
              ‚úï
            </span>
            <span class="text-slate-400 text-lg ml-1">
              {{ detailOpen ? '‚ñº' : '‚ñ∂' }}
            </span>
          </div>
        </button>

        <!-- Content -->
        <div *ngIf="detailOpen" class="p-4 border-t border-slate-700/50">
          
          <!-- Disease Detail -->
          <div *ngIf="selected.type === 'Disease'" class="space-y-4">
            <p class="text-slate-300">
              The disease <strong class="text-white">{{ selected.label }}</strong> has the following characteristics:
            </p>
            
            <ng-container *ngIf="relatedEntities.length > 0">
              <div *ngFor="let group of getGroupedRelatedEntities()">
                <p class="text-sm text-slate-400 mb-2">{{ getRelationLabel(group.type) }}:</p>
                <div class="flex flex-wrap gap-1 ml-2">
                  <button
                    *ngFor="let e of group.entities"
                    (click)="addToQuery(e)"
                    class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80"
                    [style.backgroundColor]="isInQuery(e.uri) ? typeConfig[e.type]?.color : typeConfig[e.type]?.bg"
                    [style.color]="isInQuery(e.uri) ? 'white' : typeConfig[e.type]?.color">
                    {{ typeConfig[e.type]?.icon }} {{ e.label }}
                  </button>
                </div>
              </div>
            </ng-container>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No information available
            </p>
          </div>

          <!-- Non-Disease Detail -->
          <div *ngIf="selected.type !== 'Disease'" class="space-y-4">
            <p class="text-slate-300">
              <strong class="text-white">{{ selected.label }}</strong>
              {{ getReverseRelationLabel(selected.type) }}:
            </p>
            
            <div *ngIf="relatedEntities.length > 0" class="flex flex-wrap gap-1">
              <button
                *ngFor="let e of relatedEntities"
                (click)="addToQuery(e)"
                class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80"
                [style.backgroundColor]="isInQuery(e.uri) ? typeConfig[e.type]?.color : typeConfig[e.type]?.bg"
                [style.color]="isInQuery(e.uri) ? 'white' : typeConfig[e.type]?.color">
                {{ typeConfig[e.type]?.icon }} {{ e.label }}
              </button>
            </div>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No related diseases found
            </p>
          </div>
        </div>
      </div>

      <!-- EIOS Articles Results -->
      <div
        *ngIf="query.length > 0"
        class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
        
        <div class="px-4 py-3 border-b border-slate-700 flex justify-between items-center">
          <h2 class="font-bold">üì∞ EIOS Articles</h2>
          <span class="text-sm text-emerald-400">{{ queryResults.length }} found</span>
        </div>

        <!-- Articles List -->
        <div *ngIf="queryResults.length > 0" class="divide-y divide-slate-700/50 max-h-96 overflow-y-auto">
          <div
            *ngFor="let article of queryResults; trackBy: trackById"
            class="p-4 hover:bg-slate-700/30 transition">
            
            <h3 class="font-medium text-white leading-tight mb-2">{{ article.title }}</h3>
            
            <div class="flex items-center gap-3 text-xs text-slate-400 mb-3">
              <span class="flex items-center gap-1">üì° {{ article.source }}</span>
              <span class="flex items-center gap-1">üìÖ {{ article.date }}</span>
            </div>
            
            <div class="flex flex-wrap gap-1">
              <ng-container *ngFor="let uri of article.entities">
                <button
                  *ngIf="getArticleEntity(uri) as entity"
                  (click)="addToQuery(entity)"
                  class="text-xs px-2 py-0.5 rounded-full transition"
                  [style.backgroundColor]="isInQuery(uri) ? typeConfig[entity.type]?.color : typeConfig[entity.type]?.bg"
                  [style.color]="isInQuery(uri) ? 'white' : typeConfig[entity.type]?.color"
                  [style.opacity]="isInQuery(uri) ? 1 : 0.8">
                  {{ entity.label }}
                </button>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- No Results -->
        <div *ngIf="queryResults.length === 0" class="p-8 text-center">
          <div class="text-3xl mb-2">üîç</div>
          <p class="text-slate-400">No articles found for this combination</p>
          <p class="text-slate-500 text-sm mt-1">Try removing some filters</p>
        </div>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="query.length === 0 && !selected"
        class="bg-slate-800/30 rounded-xl border border-slate-700 p-8 text-center">
        <div class="text-4xl mb-3">üîç</div>
        <h3 class="text-lg font-bold mb-2">Select an entity</h3>
        <p class="text-slate-400 text-sm">Search or click from the sidebar to build your query</p>
      </div>
    </div>
  </main>
</div>
