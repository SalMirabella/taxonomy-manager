<!-- Query Builder Component -->
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  
  <!-- Header -->
  <header class="bg-black/30 backdrop-blur border-b border-white/10 px-4 py-3 sticky top-0 z-50">
    <div class="max-w-5xl mx-auto">
      
      <!-- Title -->
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-lg font-bold">üî¨ Query Builder</h1>
        <button 
          *ngIf="query.length > 0 || selected"
          (click)="clearAll()"
          class="text-xs bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg hover:bg-red-500/30">
          ‚úï Reset
        </button>
      </div>

      <!-- Search -->
      <div class="relative" #dropdownRef>
        <input
          #searchInput
          type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()"
          (focus)="onSearchFocus()"
          placeholder="Search diseases, symptoms, vectors, hosts, hazards..."
          class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2.5 pr-10 outline-none focus:border-indigo-500 placeholder-slate-400"
        />
        
        <!-- Clear button -->
        <button
          *ngIf="searchQuery.length > 0"
          (click)="searchQuery = ''; updateSearchResults(); showDropdown = false"
          class="absolute right-3 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-slate-400 hover:text-white transition"
          title="Clear search">
          ‚úï
        </button>

        <!-- Dropdown -->
        <div 
          *ngIf="showDropdown && searchResults.length > 0"
          class="absolute z-50 w-full mt-2 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-h-96 overflow-y-auto">
          
          <ng-container *ngFor="let item of searchResults">
            <!-- Header (clickable to select "All [Category]") -->
            <button
              *ngIf="isHeader(item)"
              (click)="selectAllFromDropdown(item)"
              class="w-full px-3 py-2 text-sm font-bold bg-indigo-600 sticky top-0 text-left hover:bg-indigo-500 transition cursor-pointer">
              {{ getTypeConfig(item.type)?.icon }} {{ item.label }} (select all)
            </button>

            <!-- Category (collapsible) -->
            <ng-container *ngIf="!isHeader(item) && item.isCategory">
              <div class="flex items-stretch border-b border-slate-700/30">
                <!-- Select Category Button -->
                <button
                  (click)="addToQuery(item)"
                  class="flex-1 px-4 py-2 text-slate-300 bg-slate-700/50 text-left hover:bg-slate-700 transition"
                  [ngClass]="{'bg-indigo-500/20': isInQuery(item.uri)}">
                  <span class="flex items-center gap-2">
                    üìÇ {{ item.label }}
                    <span class="text-xs text-slate-500">({{ getChildren(item.uri, getDataKeyForEntity(item)).length }})</span>
                  </span>
                </button>
                
                <!-- Expand/Collapse Button -->
                <button
                  (click)="toggleGroup(item.uri)"
                  class="px-3 bg-slate-700/50 hover:bg-slate-700 transition text-slate-400">
                  {{ isGroupExpanded(item.uri) ? '‚ñº' : '‚ñ∂' }}
                </button>
              </div>
              
              <!-- Children -->
              <ng-container *ngIf="isGroupExpanded(item.uri)">
                <button
                  *ngFor="let child of getChildren(item.uri, getDataKeyForEntity(item))"
                  (click)="addToQuery(child)"
                  class="w-full text-left px-6 py-2 hover:bg-slate-700 flex justify-between border-b border-slate-700/30"
                  [ngClass]="{'bg-indigo-500/20': isInQuery(child.uri)}">
                  <span class="flex items-center gap-2">
                    <span [style.color]="getTypeConfig(child.type)?.color">{{ getTypeConfig(child.type)?.icon }}</span>
                    {{ child.label }}
                  </span>
                  <span 
                    class="text-xs px-2 py-0.5 rounded"
                    [style.backgroundColor]="getTypeConfig(child.type)?.bg"
                    [style.color]="getTypeConfig(child.type)?.color">
                    {{ getTypeConfig(child.type)?.label }}
                  </span>
                </button>
              </ng-container>
            </ng-container>

            <!-- Regular Entity -->
            <button
              *ngIf="!isHeader(item) && !item.isCategory"
              (click)="addToQuery(item)"
              class="w-full text-left px-4 py-2 hover:bg-slate-700 flex justify-between border-b border-slate-700/30"
              [ngClass]="{'bg-indigo-500/20': isInQuery(item.uri)}">
              <span class="flex items-center gap-2">
                <span [style.color]="getTypeConfig(item.type)?.color">{{ getTypeConfig(item.type)?.icon }}</span>
                {{ item.label }}
              </span>
              <span 
                class="text-xs px-2 py-0.5 rounded"
                [style.backgroundColor]="getTypeConfig(item.type)?.bg"
                [style.color]="getTypeConfig(item.type)?.color">
                {{ getTypeConfig(item.type)?.label }}
              </span>
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Query Display -->
      <div *ngIf="query.length > 0" class="mt-3 space-y-2">
        
        <!-- Query Widget with Tabs -->
        <div class="bg-slate-800 rounded-lg border border-slate-600">
          
          <!-- Tab Header -->
          <div class="flex border-b border-slate-600">
            <button
              (click)="queryView = 'natural'"
              class="flex-1 px-4 py-2 text-sm font-medium transition"
              [class.bg-slate-700]="queryView === 'natural'"
              [class.text-white]="queryView === 'natural'"
              [class.text-slate-400]="queryView !== 'natural'">
              üìù Natural Language
            </button>
            <button
              (click)="queryView = 'technical'"
              class="flex-1 px-4 py-2 text-sm font-medium transition"
              [class.bg-slate-700]="queryView === 'technical'"
              [class.text-white]="queryView === 'technical'"
              [class.text-slate-400]="queryView !== 'technical'">
              üíª Technical Query
            </button>
          </div>

          <!-- Tab Content -->
          <div class="p-3 overflow-visible">
            
            <!-- Natural Language -->
            <p *ngIf="queryView === 'natural'" class="text-slate-300 leading-relaxed flex flex-wrap items-center gap-1">
              <span>Select all entities that</span>
              
              <ng-container *ngFor="let qe of query; let idx = index">
                <!-- Separator -->
                <span *ngIf="idx > 0">, </span>
                
                <!-- Operator Dropdown (for ALL including first) -->
                <span class="relative inline-flex items-center">
                  <button
                    (click)="toggleOperatorDropdownForEntity(qe.entity.uri, $event)"
                    class="inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded transition text-sm font-medium bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30">
                    {{ idx === 0 ? getFirstOperatorLabel(qe.operator) : getSubsequentOperatorLabel(qe.operator) }}
                    <span class="text-xs opacity-70">‚ñº</span>
                  </button>
                  
                  <!-- Dropdown Menu -->
                  <div
                    *ngIf="isOperatorDropdownOpenForEntity(qe.entity.uri)"
                    class="absolute top-full left-0 mt-1 bg-slate-800 border border-indigo-500/40 rounded-lg shadow-xl z-[100] min-w-[100px]">
                    <button
                      (click)="selectOperatorForEntity(qe.entity.uri, 'any', $event)"
                      class="w-full text-left px-3 py-2 hover:bg-slate-700 first:rounded-t-lg transition text-sm text-indigo-300"
                      [class.bg-slate-700]="qe.operator === 'any'">
                      {{ idx === 0 ? 'have' : 'or' }}
                      <span *ngIf="qe.operator === 'any'" class="float-right">‚úì</span>
                    </button>
                    <button
                      (click)="selectOperatorForEntity(qe.entity.uri, 'all', $event)"
                      class="w-full text-left px-3 py-2 hover:bg-slate-700 transition text-sm text-indigo-300"
                      [class.bg-slate-700]="qe.operator === 'all'">
                      {{ idx === 0 ? 'have' : 'and' }}
                      <span *ngIf="qe.operator === 'all'" class="float-right">‚úì</span>
                    </button>
                    <button
                      (click)="selectOperatorForEntity(qe.entity.uri, 'none', $event)"
                      class="w-full text-left px-3 py-2 hover:bg-slate-700 last:rounded-b-lg transition text-sm text-indigo-300"
                      [class.bg-slate-700]="qe.operator === 'none'">
                      {{ idx === 0 ? 'exclude' : 'not' }}
                      <span *ngIf="qe.operator === 'none'" class="float-right">‚úì</span>
                    </button>
                  </div>
                </span>
                
                <!-- Entity -->
                <button
                  (click)="selectEntity(qe.entity)"
                  class="font-medium hover:underline inline-flex items-center gap-1"
                  [style.color]="getTypeConfig(qe.entity.type)?.color">
                  {{ getEntityDescription(qe.entity) }}
                  <button 
                    (click)="removeFromQuery(qe.entity.uri); $event.stopPropagation()"
                    class="text-xs opacity-70 hover:opacity-100">‚úï</button>
                </button>
                
                <!-- Type Label (at the end) -->
                <span *ngIf="idx === query.length - 1 && !isVirtualAllEntity(qe.entity)" class="text-slate-400">
                  {{ getTypeLabel(qe.entity.type, 1) }}
                </span>
              </ng-container>
            </p>

            <!-- Technical -->
            <div *ngIf="queryView === 'technical'" class="font-mono text-sm flex flex-wrap items-center gap-1">
              <span class="text-indigo-400">SELECT</span>
              <span class="text-emerald-400"> * </span>
              <span class="text-indigo-400">WHERE </span>
              
              <ng-container *ngFor="let qe of query; let idx = index">
                <!-- Operator Dropdown (show for first only if it's NOT) -->
                <span *ngIf="idx > 0 || qe.operator === 'none'" class="relative inline-flex items-center">
                  <button
                    (click)="toggleOperatorDropdownForEntity(qe.entity.uri, $event)"
                    class="inline-flex items-center gap-0.5 px-1.5 py-0.5 mx-0.5 rounded transition text-xs font-mono bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30">
                    {{ qe.operator === 'any' ? 'OR' : qe.operator === 'all' ? 'AND' : 'NOT' }}
                    <span class="text-[10px] opacity-70">‚ñº</span>
                  </button>
                  
                  <!-- Dropdown Menu -->
                  <div
                    *ngIf="isOperatorDropdownOpenForEntity(qe.entity.uri)"
                    class="absolute top-full left-0 mt-1 bg-slate-800 border border-indigo-500/40 rounded-lg shadow-xl z-[100] min-w-[100px]">
                    <button
                      (click)="selectOperatorForEntity(qe.entity.uri, 'any', $event)"
                      class="w-full text-left px-3 py-2 hover:bg-slate-700 first:rounded-t-lg text-xs font-mono text-indigo-300"
                      [class.bg-slate-700]="qe.operator === 'any'"
                      [class.text-slate-500]="idx === 0 && qe.operator !== 'any'">
                      {{ idx === 0 ? '(include)' : 'OR' }}
                      <span *ngIf="qe.operator === 'any'" class="float-right">‚úì</span>
                    </button>
                    <button
                      (click)="selectOperatorForEntity(qe.entity.uri, 'all', $event)"
                      class="w-full text-left px-3 py-2 hover:bg-slate-700 text-xs font-mono text-indigo-300"
                      [class.bg-slate-700]="qe.operator === 'all'"
                      [class.text-slate-500]="idx === 0 && qe.operator !== 'all'">
                      {{ idx === 0 ? '(include)' : 'AND' }}
                      <span *ngIf="qe.operator === 'all'" class="float-right">‚úì</span>
                    </button>
                    <button
                      (click)="selectOperatorForEntity(qe.entity.uri, 'none', $event)"
                      class="w-full text-left px-3 py-2 hover:bg-slate-700 last:rounded-b-lg text-xs font-mono text-indigo-300"
                      [class.bg-slate-700]="qe.operator === 'none'">
                      {{ idx === 0 ? 'NOT' : 'AND NOT' }}
                      <span *ngIf="qe.operator === 'none'" class="float-right">‚úì</span>
                    </button>
                  </div>
                </span>
                
                <!-- Entity -->
                <span class="text-slate-300">{{ getTypeConfig(qe.entity.type)?.label }}</span>
                <span class="text-slate-500"> = </span>
                <button
                  (click)="selectEntity(qe.entity)"
                  class="text-amber-400 hover:underline cursor-pointer inline-flex items-center gap-1">
                  "{{ qe.entity.label }}"<span *ngIf="qe.entity.isCategory" class="text-slate-500">*</span>
                  <button 
                    (click)="removeFromQuery(qe.entity.uri); $event.stopPropagation()"
                    class="text-xs text-slate-500 hover:text-white">‚úï</button>
                </button>
              </ng-container>
            </div>
          </div>
        </div>
        
        <!-- Results Count (outside box) -->
        <div class="flex items-center gap-2">
          <span class="text-emerald-400 text-sm font-medium">‚Üí {{ queryResults.length }} results</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto p-4 flex gap-4">
    
    <!-- Sidebar -->
    <aside class="w-60 flex-shrink-0 space-y-2 hidden lg:block">
      <div
        *ngFor="let cat of categories"
        class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">

        <!-- Category Header with Checkbox -->
        <div
          *ngIf="getCategoryItems(cat.key).length > 0"
          class="px-3 py-2 flex justify-between items-center"
          [style.backgroundColor]="getCategoryTypeConfig(cat.key)?.bg">
          
          <!-- Left side: Checkbox + Label -->
          <div class="flex items-center gap-2 flex-1">
            <input
              type="checkbox"
              [checked]="isAllCategorySelected(cat.key)"
              (change)="toggleAllCategory(cat.key)"
              class="w-4 h-4 cursor-pointer accent-indigo-600"
              (click)="$event.stopPropagation()"
            />
            <button
              (click)="selectVirtualEntity(cat.key)"
              class="flex-1 text-left flex items-center gap-1">
              <span
                class="font-bold text-sm"
                [style.color]="getCategoryTypeConfig(cat.key)?.color">
                {{ getCategoryTypeConfig(cat.key)?.icon }} {{ cat.label }}
              </span>
              <span
                class="text-xs opacity-70"
                [style.color]="getCategoryTypeConfig(cat.key)?.color">
                ({{ getSelectableCount(cat.key) }})
              </span>
            </button>
          </div>
          
          <!-- Right side: Expand/Collapse button -->
          <button
            (click)="toggleCategory(cat.key)"
            class="text-xs opacity-70 hover:opacity-100 p-1 ml-2"
            [style.color]="getCategoryTypeConfig(cat.key)?.color">
            {{ isCategoryExpanded(cat.key) ? '‚ñº' : '‚ñ∂' }}
          </button>
        </div>

        <!-- Category Content -->
        <div *ngIf="isCategoryExpanded(cat.key)" class="p-2">
          <ng-container *ngFor="let item of getCategoryItems(cat.key)">
            <!-- Render recursively -->
            <ng-container *ngTemplateOutlet="hierarchyItem; context: { $implicit: item, key: cat.key, level: 0 }"></ng-container>
          </ng-container>
        </div>
      </div>
    </aside>

    <!-- Recursive Template for Hierarchy -->
    <ng-template #hierarchyItem let-item let-key="key" let-level="level">
      <!-- Category/Subcategory with Checkbox -->
      <div *ngIf="item.isCategory" class="mb-1" [style.marginLeft.px]="level * 12">
        <div
          class="flex items-center gap-2 py-1 px-2 hover:bg-slate-700/30 rounded transition"
          [ngClass]="{
            'bg-slate-700 bg-opacity-50': isInQuery(item.uri),
            'ring-1 ring-white ring-opacity-50': selected?.uri === item.uri
          }">
          
          <!-- Checkbox -->
          <input
            type="checkbox"
            [checked]="isInQuery(item.uri)"
            (change)="addToQuery(item)"
            (click)="$event.stopPropagation()"
            class="w-3.5 h-3.5 rounded cursor-pointer flex-shrink-0"
            [style.accentColor]="getTypeConfig(item.type)?.color"
          />
          
          <!-- Label (clickable to select) -->
          <button
            (click)="selectEntity(item)"
            class="flex-1 text-left text-xs text-slate-300 hover:text-white transition truncate"
            [style.color]="getTypeConfig(item.type)?.color">
            üìÇ {{ item.label }}
            <span class="text-slate-500 ml-1">({{ getChildren(item.uri, key).length }})</span>
          </button>
          
          <!-- Expand/Collapse Arrow -->
          <button
            (click)="toggleEntityExpansion(item.uri)"
            class="text-xs opacity-50 hover:opacity-100 p-1 flex-shrink-0"
            [style.color]="getTypeConfig(item.type)?.color">
            {{ isEntityExpanded(item.uri) ? '‚ñº' : '‚ñ∂' }}
          </button>
        </div>
        
        <!-- Children (recursively) -->
        <div *ngIf="isEntityExpanded(item.uri)" class="space-y-0.5 mt-1">
          <ng-container *ngFor="let child of getChildren(item.uri, key)">
            <ng-container *ngTemplateOutlet="hierarchyItem; context: { $implicit: child, key: key, level: level + 1 }"></ng-container>
          </ng-container>
        </div>
      </div>

      <!-- Leaf Entity (instance) with Checkbox -->
      <div
        *ngIf="!item.isCategory"
        class="flex items-center gap-2 py-1 px-2 hover:bg-slate-700/30 rounded transition mb-0.5"
        [ngClass]="{
          'bg-slate-700 bg-opacity-50': isInQuery(item.uri),
          'ring-1 ring-white ring-opacity-50': selected?.uri === item.uri
        }"
        [style.marginLeft.px]="level * 12">
        
        <!-- Checkbox -->
        <input
          type="checkbox"
          [checked]="isInQuery(item.uri)"
          (change)="addToQuery(item)"
          (click)="$event.stopPropagation()"
          class="w-3.5 h-3.5 rounded cursor-pointer flex-shrink-0"
          [style.accentColor]="getTypeConfig(item.type)?.color"
        />
        
        <!-- Label (clickable to view details) -->
        <button
          (click)="selectEntity(item)"
          class="flex-1 text-left text-xs text-slate-300 hover:text-white transition truncate"
          [style.color]="getTypeConfig(item.type)?.color">
          {{ item.label }}
        </button>
      </div>
    </ng-template>

    <!-- Main Panel -->
    <div class="flex-1 space-y-4">
      
      <!-- Entity Detail Panel (Collapsible) -->
      <div
        *ngIf="selected"
        class="bg-slate-800/50 rounded-xl border overflow-hidden"
        [style.borderColor]="getSelectedConfig()?.color + '50'">
        
        <!-- Header (clickable to toggle) -->
        <button
          (click)="detailOpen = !detailOpen"
          class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition"
          [style.backgroundColor]="getSelectedConfig()?.bg">
          <div class="flex items-center gap-3">
            <h3
              class="font-bold text-lg flex items-center gap-2"
              [style.color]="getSelectedConfig()?.color">
              <span *ngIf="selected.isCategory">üìÇ</span>
              {{ getSelectedConfig()?.icon }} {{ selected.label }}
              <span class="text-sm font-normal opacity-70">({{ getSelectedConfig()?.label }}{{ selected.isCategory ? ' Category' : '' }})</span>
            </h3>
            <button
              *ngIf="!isInQuery(selected.uri)"
              (click)="$event.stopPropagation(); addToQuery(selected)"
              class="text-xs px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white cursor-pointer transition font-medium flex-shrink-0"
              title="Add to query">
              + Add to query
            </button>
          </div>
          <div class="flex items-center gap-2">
            <span
              *ngIf="isInQuery(selected.uri)"
              (click)="$event.stopPropagation(); removeFromQuery(selected.uri)"
              class="text-xs px-2 py-1 rounded bg-white/20 hover:bg-white/30 cursor-pointer transition flex-shrink-0"
              [style.color]="getSelectedConfig()?.color">
              Remove from query
            </span>
            <button
              (click)="$event.stopPropagation(); selected = null"
              class="w-7 h-7 rounded-full bg-slate-700/50 hover:bg-slate-600 flex items-center justify-center text-slate-300 hover:text-white transition flex-shrink-0"
              title="Close detail panel">
              ‚úï
            </button>
            <span class="text-slate-400 text-lg ml-1">
              {{ detailOpen ? '‚ñº' : '‚ñ∂' }}
            </span>
          </div>
        </button>

        <!-- Content -->
        <div *ngIf="detailOpen" class="p-4 border-t border-slate-700/50">
          
          <!-- Category Detail -->
          <div *ngIf="selected.isCategory" class="space-y-4">
            <div class="flex items-start justify-between gap-4">
              <p class="text-slate-300 flex-1">
                The category <strong class="text-white">{{ selected.label }}</strong> 
                <span *ngIf="selected.type === 'Disease'">includes the following diseases and their associated entities:</span>
                <span *ngIf="selected.type !== 'Disease'"> includes the following entities:</span>
              </p>
              <button
                *ngIf="!isInQuery(selected.uri)"
                (click)="addToQuery(selected)"
                class="flex-shrink-0 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium transition"
                title="Add to query">
                + Add to query
              </button>
            </div>
            
            <!-- For Disease categories: show aggregated relationships -->
            <ng-container *ngIf="selected.type === 'Disease' && relatedEntities.length > 0">
              <div class="bg-slate-700/30 rounded-lg p-3 mb-3">
                <p class="text-xs text-slate-400 mb-2">
                  <strong>Aggregated properties</strong> from all diseases in this category:
                </p>
              </div>
              
              <div *ngFor="let group of getGroupedRelatedEntities()">
                <p class="text-sm text-slate-400 mb-2">{{ getRelationLabel(group.type) }}:</p>
                <div class="flex flex-wrap gap-1 ml-2 mb-3">
                  <div
                    *ngFor="let e of group.entities"
                    class="relative group/entity pointer-events-none">
                    <button
                      (click)="selectEntity(e)"
                      class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80 transition pointer-events-auto"
                      [ngClass]="{'ring-2 ring-white ring-opacity-50': selected?.uri === e.uri}"
                      [style.backgroundColor]="isInQuery(e.uri) ? getTypeConfig(e.type)?.color : getTypeConfig(e.type)?.bg"
                      [style.color]="isInQuery(e.uri) ? 'white' : getTypeConfig(e.type)?.color">
                      {{ getTypeConfig(e.type)?.icon }} {{ e.label }}
                    </button>
                    <!-- Toggle Add/Remove button -->
                    <button
                      (click)="isInQuery(e.uri) ? removeFromQueryWithoutNavigation(e.uri, $event) : addToQueryWithoutNavigation(e, $event)"
                      class="absolute -top-1 -right-1 w-5 h-5 rounded-full z-10 text-white text-xs opacity-0 group-hover/entity:opacity-100 transition flex items-center justify-center pointer-events-auto z-20"
                      [class.bg-indigo-500]="!isInQuery(e.uri)"
                      [class.hover:bg-indigo-600]="!isInQuery(e.uri)"
                      [class.bg-red-500]="isInQuery(e.uri)"
                      [class.hover:bg-red-600]="isInQuery(e.uri)"
                      [title]="isInQuery(e.uri) ? 'Remove from query' : 'Add to query'">
                      {{ isInQuery(e.uri) ? '‚úï' : '+' }}
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- For non-Disease categories: show inverse relations (diseases that use these entities) -->
            <ng-container *ngIf="selected.type !== 'Disease' && getRelatedDiseases().length > 0">
              <div class="border-t border-slate-700 pt-3 mt-3">
                <p class="text-sm text-slate-400 mb-2">
                  <strong>{{ getReverseRelationLabel(selected.type) }}:</strong>
                </p>
                <div class="flex flex-wrap gap-1 ml-2 mb-3">
                  <div
                    *ngFor="let disease of getRelatedDiseases()"
                    class="relative group/entity pointer-events-none">
                    <button
                      (click)="selectEntity(disease)"
                      class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80 transition pointer-events-auto"
                      [ngClass]="{'ring-2 ring-white ring-opacity-50': selected?.uri === disease.uri}"
                      [style.backgroundColor]="isInQuery(disease.uri) ? getTypeConfig(disease.type)?.color : getTypeConfig(disease.type)?.bg"
                      [style.color]="isInQuery(disease.uri) ? 'white' : getTypeConfig(disease.type)?.color">
                      {{ getTypeConfig(disease.type)?.icon }} {{ disease.label }}
                    </button>
                    <!-- Toggle Add/Remove button -->
                    <button
                      (click)="isInQuery(disease.uri) ? removeFromQueryWithoutNavigation(disease.uri, $event) : addToQueryWithoutNavigation(disease, $event)"
                      class="absolute -top-1 -right-1 w-5 h-5 rounded-full z-10 text-white text-xs opacity-0 group-hover/entity:opacity-100 transition flex items-center justify-center pointer-events-auto z-20"
                      [class.bg-indigo-500]="!isInQuery(disease.uri)"
                      [class.hover:bg-indigo-600]="!isInQuery(disease.uri)"
                      [class.bg-red-500]="isInQuery(disease.uri)"
                      [class.hover:bg-red-600]="isInQuery(disease.uri)"
                      [title]="isInQuery(disease.uri) ? 'Remove from query' : 'Add to query'">
                      {{ isInQuery(disease.uri) ? '‚úï' : '+' }}
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
            
            <!-- Show direct children (diseases/entities in this category) -->
            <div class="border-t border-slate-700 pt-3 mt-3">
              <p class="text-sm text-slate-400 mb-2">
                <strong>{{ selected.type === 'Disease' ? 'Diseases' : 'Entities' }}</strong> in this category:
              </p>
              <div class="grid grid-cols-2 gap-2">
                <div
                  *ngFor="let child of (selected.type === 'Disease' ? getDiseaseInstances() : getCategoryInstances())"
                  class="relative group/entity pointer-events-none">
                  <button
                    (click)="selectEntity(child)"
                    class="w-full text-left text-sm px-3 py-2 rounded-lg hover:opacity-80 transition flex items-center gap-2 pointer-events-auto"
                    [ngClass]="{'ring-2 ring-white ring-opacity-50': selected?.uri === child.uri}"
                    [style.backgroundColor]="isInQuery(child.uri) ? getTypeConfig(child.type)?.color : getTypeConfig(child.type)?.bg"
                    [style.color]="isInQuery(child.uri) ? 'white' : getTypeConfig(child.type)?.color">
                    <span *ngIf="child.isCategory">üìÇ</span>
                    <span *ngIf="!child.isCategory">{{ getTypeConfig(child.type)?.icon }}</span>
                    <span>{{ child.label }}</span>
                  </button>
                  <!-- Toggle Add/Remove button -->
                  <button
                    (click)="isInQuery(child.uri) ? removeFromQueryWithoutNavigation(child.uri, $event) : addToQueryWithoutNavigation(child, $event)"
                    class="absolute top-1 right-1 w-5 h-5 rounded-full text-white text-xs opacity-0 group-hover/entity:opacity-100 transition flex items-center justify-center pointer-events-auto z-20"
                    [class.bg-indigo-500]="!isInQuery(child.uri)"
                    [class.hover:bg-indigo-600]="!isInQuery(child.uri)"
                    [class.bg-red-500]="isInQuery(child.uri)"
                    [class.hover:bg-red-600]="isInQuery(child.uri)"
                    [title]="isInQuery(child.uri) ? 'Remove from query' : 'Add to query'">
                    {{ isInQuery(child.uri) ? '‚úï' : '+' }}
                  </button>
                </div>
              </div>
            </div>
            
            <p *ngIf="(selected.type === 'Disease' ? getDiseaseInstances() : getCategoryInstances()).length === 0" class="text-slate-500">
              No entities in this category
            </p>
          </div>

          <!-- Disease Instance Detail -->
          <div *ngIf="!selected.isCategory && selected.type === 'Disease'" class="space-y-4">
            <div class="flex items-start justify-between gap-4">
              <p class="text-slate-300 flex-1">
                The disease <strong class="text-white">{{ selected.label }}</strong> has the following characteristics:
              </p>
              <button
                *ngIf="!isInQuery(selected.uri)"
                (click)="addToQuery(selected)"
                class="flex-shrink-0 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium transition"
                title="Add to query">
                + Add to query
              </button>
            </div>
            
            <ng-container *ngIf="relatedEntities.length > 0">
              <div *ngFor="let group of getGroupedRelatedEntities()">
                <p class="text-sm text-slate-400 mb-2">{{ getRelationLabel(group.type) }}:</p>
                <div class="flex flex-wrap gap-1 ml-2">
                  <div
                    *ngFor="let e of group.entities"
                    class="relative group/entity pointer-events-none">
                    <button
                      (click)="selectEntity(e)"
                      class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80 transition pointer-events-auto"
                      [ngClass]="{'ring-2 ring-white ring-opacity-50': selected?.uri === e.uri}"
                      [style.backgroundColor]="isInQuery(e.uri) ? getTypeConfig(e.type)?.color : getTypeConfig(e.type)?.bg"
                      [style.color]="isInQuery(e.uri) ? 'white' : getTypeConfig(e.type)?.color">
                      {{ getTypeConfig(e.type)?.icon }} {{ e.label }}
                    </button>
                    <!-- Toggle Add/Remove button -->
                    <button
                      (click)="isInQuery(e.uri) ? removeFromQueryWithoutNavigation(e.uri, $event) : addToQueryWithoutNavigation(e, $event)"
                      class="absolute -top-1 -right-1 w-5 h-5 rounded-full z-10 text-white text-xs opacity-0 group-hover/entity:opacity-100 transition flex items-center justify-center pointer-events-auto z-20"
                      [class.bg-indigo-500]="!isInQuery(e.uri)"
                      [class.hover:bg-indigo-600]="!isInQuery(e.uri)"
                      [class.bg-red-500]="isInQuery(e.uri)"
                      [class.hover:bg-red-600]="isInQuery(e.uri)"
                      [title]="isInQuery(e.uri) ? 'Remove from query' : 'Add to query'">
                      {{ isInQuery(e.uri) ? '‚úï' : '+' }}
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No information available
            </p>
          </div>

          <!-- Non-Disease Instance Detail -->
          <div *ngIf="!selected.isCategory && selected.type !== 'Disease'" class="space-y-4">
            <p class="text-slate-300">
              <strong class="text-white">{{ selected.label }}</strong>
              {{ getReverseRelationLabel(selected.type) }}:
            </p>
            
            <div *ngIf="relatedEntities.length > 0" class="flex flex-wrap gap-1">
              <div
                *ngFor="let e of relatedEntities"
                class="relative group/entity pointer-events-none">
                <button
                  (click)="selectEntity(e)"
                  class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80 transition pointer-events-auto"
                  [ngClass]="{'ring-2 ring-white ring-opacity-50': selected?.uri === e.uri}"
                  [style.backgroundColor]="isInQuery(e.uri) ? getTypeConfig(e.type)?.color : getTypeConfig(e.type)?.bg"
                  [style.color]="isInQuery(e.uri) ? 'white' : getTypeConfig(e.type)?.color">
                  {{ getTypeConfig(e.type)?.icon }} {{ e.label }}
                </button>
                <!-- Toggle Add/Remove button -->
                <button
                  (click)="isInQuery(e.uri) ? removeFromQueryWithoutNavigation(e.uri, $event) : addToQueryWithoutNavigation(e, $event)"
                  class="absolute -top-1 -right-1 w-5 h-5 rounded-full z-10 text-white text-xs opacity-0 group-hover/entity:opacity-100 transition flex items-center justify-center pointer-events-auto z-20"
                  [class.bg-indigo-500]="!isInQuery(e.uri)"
                  [class.hover:bg-indigo-600]="!isInQuery(e.uri)"
                  [class.bg-red-500]="isInQuery(e.uri)"
                  [class.hover:bg-red-600]="isInQuery(e.uri)"
                  [title]="isInQuery(e.uri) ? 'Remove from query' : 'Add to query'">
                  {{ isInQuery(e.uri) ? '‚úï' : '+' }}
                </button>
              </div>
            </div>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No related diseases found
            </p>
          </div>
        </div>
      </div>

      <!-- EIOS Articles Results -->
      <div
        *ngIf="query.length > 0"
        class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
        
        <div class="px-4 py-3 border-b border-slate-700 flex justify-between items-center">
          <h2 class="font-bold">üì∞ EIOS Articles</h2>
          <span class="text-sm text-emerald-400">{{ queryResults.length }} found</span>
        </div>

        <!-- Articles List -->
        <div *ngIf="queryResults.length > 0" class="divide-y divide-slate-700/50 max-h-96 overflow-y-auto">
          <div
            *ngFor="let article of queryResults; trackBy: trackById"
            class="p-4 hover:bg-slate-700/30 transition">
            
            <h3 class="font-medium text-white leading-tight mb-2">{{ article.title }}</h3>
            
            <div class="flex items-center gap-3 text-xs text-slate-400 mb-3">
              <span class="flex items-center gap-1">üì° {{ article.source }}</span>
              <span class="flex items-center gap-1">üìÖ {{ article.date }}</span>
            </div>
            
            <div class="flex flex-wrap gap-1">
              <ng-container *ngFor="let uri of article.entities">
                <button
                  *ngIf="getArticleEntity(uri) as entity"
                  (click)="addToQuery(entity)"
                  class="text-xs px-2 py-0.5 rounded-full transition"
                  [style.backgroundColor]="isInQuery(uri) ? typeConfig[entity.type].color : typeConfig[entity.type].bg"
                  [style.color]="isInQuery(uri) ? 'white' : typeConfig[entity.type].color"
                  [style.opacity]="isInQuery(uri) ? 1 : 0.8">
                  {{ entity.label }}
                </button>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- No Results -->
        <div *ngIf="queryResults.length === 0" class="p-8 text-center">
          <div class="text-3xl mb-2">üîç</div>
          <p class="text-slate-400">No articles found for this combination</p>
          <p class="text-slate-500 text-sm mt-1">Try removing some filters</p>
        </div>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="query.length === 0 && !selected"
        class="bg-slate-800/30 rounded-xl border border-slate-700 p-8 text-center">
        <div class="text-4xl mb-3">üîç</div>
        <h3 class="text-lg font-bold mb-2">Select an entity</h3>
        <p class="text-slate-400 text-sm">Search or click from the sidebar to build your query</p>
      </div>
    </div>
  </main>
</div>
