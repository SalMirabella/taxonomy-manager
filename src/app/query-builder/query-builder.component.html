<!-- Query Builder Component -->
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  
  <!-- Header -->
  <header class="bg-black/30 backdrop-blur border-b border-white/10 px-4 py-3 sticky top-0 z-50">
    <div class="max-w-5xl mx-auto">
      
      <!-- Title -->
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-lg font-bold">üî¨ Query Builder</h1>
        <button 
          *ngIf="query.length > 0 || selected"
          (click)="clearAll()"
          class="text-xs bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg hover:bg-red-500/30">
          ‚úï Reset
        </button>
      </div>

      <!-- Search -->
      <div class="relative" #dropdownRef>
        <input
          #searchInput
          type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()"
          (focus)="onSearchFocus()"
          placeholder="Search diseases, symptoms, vectors, hosts, hazards..."
          class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2.5 outline-none focus:border-indigo-500 placeholder-slate-400"
        />

        <!-- Dropdown -->
        <div 
          *ngIf="showDropdown && searchResults.length > 0"
          class="absolute z-50 w-full mt-2 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-h-96 overflow-y-auto">
          
          <ng-container *ngFor="let item of searchResults">
            <!-- Header (clickable to select "All [Category]") -->
            <button
              *ngIf="isHeader(item)"
              (click)="selectAllFromDropdown(item)"
              class="w-full px-3 py-2 text-sm font-bold bg-indigo-600 sticky top-0 text-left hover:bg-indigo-500 transition cursor-pointer">
              {{ getTypeConfig(item.type)?.icon }} {{ item.label }} (select all)
            </button>

            <!-- Category (collapsible) -->
            <ng-container *ngIf="!isHeader(item) && item.isCategory">
              <div class="flex items-stretch border-b border-slate-700/30">
                <!-- Select Category Button -->
                <button
                  (click)="addToQuery(item)"
                  class="flex-1 px-4 py-2 text-slate-300 bg-slate-700/50 text-left hover:bg-slate-700 transition"
                  [ngClass]="{'bg-indigo-500/20': isInQuery(item.uri)}">
                  <span class="flex items-center gap-2">
                    üìÇ {{ item.label }}
                    <span class="text-xs text-slate-500">({{ getChildren(item.uri, getDataKeyForEntity(item)).length }})</span>
                  </span>
                </button>
                
                <!-- Expand/Collapse Button -->
                <button
                  (click)="toggleGroup(item.uri)"
                  class="px-3 bg-slate-700/50 hover:bg-slate-700 transition text-slate-400">
                  {{ isGroupExpanded(item.uri) ? '‚ñº' : '‚ñ∂' }}
                </button>
              </div>
              
              <!-- Children -->
              <ng-container *ngIf="isGroupExpanded(item.uri)">
                <button
                  *ngFor="let child of getChildren(item.uri, getDataKeyForEntity(item))"
                  (click)="addToQuery(child)"
                  class="w-full text-left px-6 py-2 hover:bg-slate-700 flex justify-between border-b border-slate-700/30"
                  [ngClass]="{'bg-indigo-500/20': isInQuery(child.uri)}">
                  <span class="flex items-center gap-2">
                    <span [style.color]="getTypeConfig(child.type)?.color">{{ getTypeConfig(child.type)?.icon }}</span>
                    {{ child.label }}
                  </span>
                  <span 
                    class="text-xs px-2 py-0.5 rounded"
                    [style.backgroundColor]="getTypeConfig(child.type)?.bg"
                    [style.color]="getTypeConfig(child.type)?.color">
                    {{ getTypeConfig(child.type)?.label }}
                  </span>
                </button>
              </ng-container>
            </ng-container>

            <!-- Regular Entity -->
            <button
              *ngIf="!isHeader(item) && !item.isCategory"
              (click)="addToQuery(item)"
              class="w-full text-left px-4 py-2 hover:bg-slate-700 flex justify-between border-b border-slate-700/30"
              [ngClass]="{'bg-indigo-500/20': isInQuery(item.uri)}">
              <span class="flex items-center gap-2">
                <span [style.color]="getTypeConfig(item.type)?.color">{{ getTypeConfig(item.type)?.icon }}</span>
                {{ item.label }}
              </span>
              <span 
                class="text-xs px-2 py-0.5 rounded"
                [style.backgroundColor]="getTypeConfig(item.type)?.bg"
                [style.color]="getTypeConfig(item.type)?.color">
                {{ getTypeConfig(item.type)?.label }}
              </span>
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Query Display -->
      <div *ngIf="query.length > 0" class="mt-3 space-y-2">
        
        <!-- Query Widget with Tabs -->
        <div class="bg-slate-800 rounded-lg border border-slate-600 overflow-hidden">
          
          <!-- Tab Header -->
          <div class="flex border-b border-slate-600">
            <button
              (click)="queryView = 'natural'"
              class="flex-1 px-4 py-2 text-sm font-medium transition"
              [class.bg-slate-700]="queryView === 'natural'"
              [class.text-white]="queryView === 'natural'"
              [class.text-slate-400]="queryView !== 'natural'">
              üìù Natural Language
            </button>
            <button
              (click)="queryView = 'technical'"
              class="flex-1 px-4 py-2 text-sm font-medium transition"
              [class.bg-slate-700]="queryView === 'technical'"
              [class.text-white]="queryView === 'technical'"
              [class.text-slate-400]="queryView !== 'technical'">
              üíª Technical Query
            </button>
          </div>

          <!-- Tab Content -->
          <div class="p-3">
            
            <!-- Natural Language -->
            <p *ngIf="queryView === 'natural'" class="text-slate-300 leading-relaxed">
              Select all entities that have
              <ng-container *ngFor="let group of getGroupedQuery(); let groupIdx = index">
                <span *ngIf="groupIdx > 0">, </span>
                <ng-container *ngFor="let q of group.items; let idx = index">
                  <span *ngIf="idx > 0 && idx < group.items.length - 1">, </span>
                  <span *ngIf="idx > 0 && idx === group.items.length - 1"> and </span>
                  <button
                    (click)="selectEntity(q)"
                    class="font-medium hover:underline"
                    [style.color]="getTypeConfig(q.type)?.color">
                    {{ getEntityDescription(q) }}
                  </button>
                </ng-container>
                <span *ngIf="!isVirtualAllEntity(group.items[0])" class="text-slate-400"> {{ getTypeLabel(group.type, group.items.length) }}</span>
              </ng-container>
              <span class="text-emerald-400 ml-1">‚Üí {{ queryResults.length }} results</span>
            </p>

            <!-- Technical -->
            <div *ngIf="queryView === 'technical'" class="font-mono text-sm">
              <span class="text-indigo-400">SELECT</span>
              <span class="text-emerald-400"> * </span>
              <span class="text-indigo-400">WHERE </span>
              <ng-container *ngFor="let q of query; let idx = index">
                <span *ngIf="idx > 0" class="text-indigo-400"> AND </span>
                <span class="text-slate-300">{{ getTypeConfig(q.type)?.label }}</span>
                <span class="text-slate-500"> = </span>
                <button
                  (click)="selectEntity(q)"
                  class="text-amber-400 hover:underline cursor-pointer">
                  "{{ q.label }}"<span *ngIf="q.isCategory" class="text-slate-500">*</span>
                </button>
              </ng-container>
              <span class="text-emerald-400 ml-2">‚Üí {{ queryResults.length }} results</span>
            </div>
          </div>
        </div>

        <!-- Filter Chips -->
        <div class="flex flex-wrap gap-2">
          <span
            *ngFor="let q of query"
            class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm cursor-pointer"
            [class.ring-2]="selected?.uri === q.uri"
            [class.ring-white]="selected?.uri === q.uri"
            [style.backgroundColor]="getTypeConfig(q.type)?.bg"
            [style.color]="getTypeConfig(q.type)?.color">
            <button (click)="selectEntity(q)" class="flex items-center gap-1 hover:opacity-80">
              {{ getTypeConfig(q.type)?.icon }}
              <span *ngIf="q.isCategory" class="text-xs opacity-60">üìÇ</span>
              {{ q.label }}
              <span *ngIf="q.isCategory" class="text-xs opacity-70">
                ({{ getChildren(q.uri, getDataKeyForEntity(q)).length }})
              </span>
            </button>
            <button (click)="removeFromQuery(q.uri)" class="ml-1 hover:opacity-70">‚úï</button>
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto p-4 flex gap-4">
    
    <!-- Sidebar -->
    <aside class="w-60 flex-shrink-0 space-y-2 hidden lg:block">
      <div
        *ngFor="let cat of categories"
        class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">

        <!-- Category Header with Checkbox -->
        <div
          *ngIf="getCategoryItems(cat.key).length > 0"
          class="px-3 py-2 flex justify-between items-center"
          [style.backgroundColor]="getCategoryTypeConfig(cat.key)?.bg">
          
          <!-- Left side: Checkbox + Label -->
          <div class="flex items-center gap-2 flex-1">
            <input
              type="checkbox"
              [checked]="isAllCategorySelected(cat.key)"
              (change)="toggleAllCategory(cat.key)"
              class="w-4 h-4 cursor-pointer accent-indigo-600"
              (click)="$event.stopPropagation()"
            />
            <button
              (click)="selectVirtualEntity(cat.key)"
              class="flex-1 text-left flex items-center gap-1">
              <span
                class="font-bold text-sm"
                [style.color]="getCategoryTypeConfig(cat.key)?.color">
                {{ getCategoryTypeConfig(cat.key)?.icon }} {{ cat.label }}
              </span>
              <span
                class="text-xs opacity-70"
                [style.color]="getCategoryTypeConfig(cat.key)?.color">
                ({{ getSelectableCount(cat.key) }})
              </span>
            </button>
          </div>
          
          <!-- Right side: Expand/Collapse button -->
          <button
            (click)="toggleCategory(cat.key)"
            class="text-xs opacity-70 hover:opacity-100 p-1 ml-2"
            [style.color]="getCategoryTypeConfig(cat.key)?.color">
            {{ isCategoryExpanded(cat.key) ? '‚ñº' : '‚ñ∂' }}
          </button>
        </div>

        <!-- Category Content -->
        <div *ngIf="isCategoryExpanded(cat.key)" class="p-2">
          <ng-container *ngFor="let item of getCategoryItems(cat.key)">
            <!-- Render recursively -->
            <ng-container *ngTemplateOutlet="hierarchyItem; context: { $implicit: item, key: cat.key, level: 0 }"></ng-container>
          </ng-container>
        </div>
      </div>
    </aside>

    <!-- Recursive Template for Hierarchy -->
    <ng-template #hierarchyItem let-item let-key="key" let-level="level">
      <!-- Category/Subcategory with Checkbox -->
      <div *ngIf="item.isCategory" class="mb-1" [style.marginLeft.px]="level * 12">
        <div
          class="flex items-center gap-2 py-1 px-2 hover:bg-slate-700/30 rounded transition"
          [ngClass]="{
            'bg-slate-700 bg-opacity-50': isInQuery(item.uri),
            'ring-1 ring-white ring-opacity-50': selected?.uri === item.uri
          }">
          
          <!-- Checkbox -->
          <input
            type="checkbox"
            [checked]="isInQuery(item.uri)"
            (change)="addToQuery(item)"
            (click)="$event.stopPropagation()"
            class="w-3.5 h-3.5 rounded cursor-pointer flex-shrink-0"
            [style.accentColor]="getTypeConfig(item.type)?.color"
          />
          
          <!-- Label (clickable to select) -->
          <button
            (click)="selectEntity(item)"
            class="flex-1 text-left text-xs text-slate-300 hover:text-white transition truncate"
            [style.color]="getTypeConfig(item.type)?.color">
            üìÇ {{ item.label }}
            <span class="text-slate-500 ml-1">({{ getChildren(item.uri, key).length }})</span>
          </button>
          
          <!-- Expand/Collapse Arrow -->
          <button
            (click)="toggleEntityExpansion(item.uri)"
            class="text-xs opacity-50 hover:opacity-100 p-1 flex-shrink-0"
            [style.color]="getTypeConfig(item.type)?.color">
            {{ isEntityExpanded(item.uri) ? '‚ñº' : '‚ñ∂' }}
          </button>
        </div>
        
        <!-- Children (recursively) -->
        <div *ngIf="isEntityExpanded(item.uri)" class="space-y-0.5 mt-1">
          <ng-container *ngFor="let child of getChildren(item.uri, key)">
            <ng-container *ngTemplateOutlet="hierarchyItem; context: { $implicit: child, key: key, level: level + 1 }"></ng-container>
          </ng-container>
        </div>
      </div>

      <!-- Leaf Entity (instance) with Checkbox -->
      <div
        *ngIf="!item.isCategory"
        class="flex items-center gap-2 py-1 px-2 hover:bg-slate-700/30 rounded transition mb-0.5"
        [ngClass]="{
          'bg-slate-700 bg-opacity-50': isInQuery(item.uri),
          'ring-1 ring-white ring-opacity-50': selected?.uri === item.uri
        }"
        [style.marginLeft.px]="level * 12">
        
        <!-- Checkbox -->
        <input
          type="checkbox"
          [checked]="isInQuery(item.uri)"
          (change)="addToQuery(item)"
          (click)="$event.stopPropagation()"
          class="w-3.5 h-3.5 rounded cursor-pointer flex-shrink-0"
          [style.accentColor]="getTypeConfig(item.type)?.color"
        />
        
        <!-- Label (clickable to view details) -->
        <button
          (click)="selectEntity(item)"
          class="flex-1 text-left text-xs text-slate-300 hover:text-white transition truncate"
          [style.color]="getTypeConfig(item.type)?.color">
          {{ item.label }}
        </button>
      </div>
    </ng-template>

    <!-- Main Panel -->
    <div class="flex-1 space-y-4">
      
      <!-- Entity Detail Panel (Collapsible) -->
      <div
        *ngIf="selected"
        class="bg-slate-800/50 rounded-xl border overflow-hidden"
        [style.borderColor]="getSelectedConfig()?.color + '50'">
        
        <!-- Header (clickable to toggle) -->
        <button
          (click)="detailOpen = !detailOpen"
          class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition"
          [style.backgroundColor]="getSelectedConfig()?.bg">
          <h3
            class="font-bold text-lg flex items-center gap-2"
            [style.color]="getSelectedConfig()?.color">
            <span *ngIf="selected.isCategory">üìÇ</span>
            {{ getSelectedConfig()?.icon }} {{ selected.label }}
            <span class="text-sm font-normal opacity-70">({{ getSelectedConfig()?.label }}{{ selected.isCategory ? ' Category' : '' }})</span>
          </h3>
          <div class="flex items-center gap-2">
            <span
              *ngIf="isInQuery(selected.uri)"
              (click)="$event.stopPropagation(); removeFromQuery(selected.uri)"
              class="text-xs px-2 py-1 rounded bg-white/20 hover:bg-white/30 cursor-pointer"
              [style.color]="getSelectedConfig()?.color">
              Remove from query
            </span>
            <span
              (click)="$event.stopPropagation(); selected = null"
              class="opacity-70 hover:opacity-100 text-lg cursor-pointer">
              ‚úï
            </span>
            <span class="text-slate-400 text-lg ml-1">
              {{ detailOpen ? '‚ñº' : '‚ñ∂' }}
            </span>
          </div>
        </button>

        <!-- Content -->
        <div *ngIf="detailOpen" class="p-4 border-t border-slate-700/50">
          
          <!-- Category Detail -->
          <div *ngIf="selected.isCategory" class="space-y-4">
            <p class="text-slate-300">
              The category <strong class="text-white">{{ selected.label }}</strong> 
              <span *ngIf="selected.type === 'Disease'">includes the following diseases and their associated entities:</span>
              <span *ngIf="selected.type !== 'Disease'"> includes the following entities:</span>
            </p>
            
            <!-- For Disease categories: show aggregated relationships -->
            <ng-container *ngIf="selected.type === 'Disease' && relatedEntities.length > 0">
              <div class="bg-slate-700/30 rounded-lg p-3 mb-3">
                <p class="text-xs text-slate-400 mb-2">
                  <strong>Aggregated properties</strong> from all diseases in this category:
                </p>
              </div>
              
              <div *ngFor="let group of getGroupedRelatedEntities()">
                <p class="text-sm text-slate-400 mb-2">{{ getRelationLabel(group.type) }}:</p>
                <div class="flex flex-wrap gap-1 ml-2 mb-3">
                  <button
                    *ngFor="let e of group.entities"
                    (click)="addToQuery(e)"
                    class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80"
                    [style.backgroundColor]="isInQuery(e.uri) ? getTypeConfig(e.type)?.color : getTypeConfig(e.type)?.bg"
                    [style.color]="isInQuery(e.uri) ? 'white' : getTypeConfig(e.type)?.color">
                    {{ getTypeConfig(e.type)?.icon }} {{ e.label }}
                  </button>
                </div>
              </div>
            </ng-container>

            <!-- For non-Disease categories: show inverse relations (diseases that use these entities) -->
            <ng-container *ngIf="selected.type !== 'Disease' && getRelatedDiseases().length > 0">
              <div class="border-t border-slate-700 pt-3 mt-3">
                <p class="text-sm text-slate-400 mb-2">
                  <strong>{{ getReverseRelationLabel(selected.type) }}:</strong>
                </p>
                <div class="flex flex-wrap gap-1 ml-2 mb-3">
                  <button
                    *ngFor="let disease of getRelatedDiseases()"
                    (click)="addToQuery(disease)"
                    class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80"
                    [style.backgroundColor]="isInQuery(disease.uri) ? getTypeConfig(disease.type)?.color : getTypeConfig(disease.type)?.bg"
                    [style.color]="isInQuery(disease.uri) ? 'white' : getTypeConfig(disease.type)?.color">
                    {{ getTypeConfig(disease.type)?.icon }} {{ disease.label }}
                  </button>
                </div>
              </div>
            </ng-container>
            
            <!-- Show direct children (diseases/entities in this category) -->
            <div class="border-t border-slate-700 pt-3 mt-3">
              <p class="text-sm text-slate-400 mb-2">
                <strong>{{ selected.type === 'Disease' ? 'Diseases' : 'Entities' }}</strong> in this category:
              </p>
              <div class="grid grid-cols-2 gap-2">
                <button
                  *ngFor="let child of getCategoryInstances()"
                  (click)="addToQuery(child)"
                  class="text-left text-sm px-3 py-2 rounded-lg hover:opacity-80 transition flex items-center gap-2"
                  [style.backgroundColor]="isInQuery(child.uri) ? getTypeConfig(child.type)?.color : getTypeConfig(child.type)?.bg"
                  [style.color]="isInQuery(child.uri) ? 'white' : getTypeConfig(child.type)?.color">
                  <span *ngIf="child.isCategory">üìÇ</span>
                  <span *ngIf="!child.isCategory">{{ getTypeConfig(child.type)?.icon }}</span>
                  <span>{{ child.label }}</span>
                </button>
              </div>
            </div>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No entities in this category
            </p>
          </div>

          <!-- Disease Instance Detail -->
          <div *ngIf="!selected.isCategory && selected.type === 'Disease'" class="space-y-4">
            <p class="text-slate-300">
              The disease <strong class="text-white">{{ selected.label }}</strong> has the following characteristics:
            </p>
            
            <ng-container *ngIf="relatedEntities.length > 0">
              <div *ngFor="let group of getGroupedRelatedEntities()">
                <p class="text-sm text-slate-400 mb-2">{{ getRelationLabel(group.type) }}:</p>
                <div class="flex flex-wrap gap-1 ml-2">
                  <button
                    *ngFor="let e of group.entities"
                    (click)="addToQuery(e)"
                    class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80"
                    [style.backgroundColor]="isInQuery(e.uri) ? getTypeConfig(e.type)?.color : getTypeConfig(e.type)?.bg"
                    [style.color]="isInQuery(e.uri) ? 'white' : getTypeConfig(e.type)?.color">
                    {{ getTypeConfig(e.type)?.icon }} {{ e.label }}
                  </button>
                </div>
              </div>
            </ng-container>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No information available
            </p>
          </div>

          <!-- Non-Disease Instance Detail -->
          <div *ngIf="!selected.isCategory && selected.type !== 'Disease'" class="space-y-4">
            <p class="text-slate-300">
              <strong class="text-white">{{ selected.label }}</strong>
              {{ getReverseRelationLabel(selected.type) }}:
            </p>
            
            <div *ngIf="relatedEntities.length > 0" class="flex flex-wrap gap-1">
              <button
                *ngFor="let e of relatedEntities"
                (click)="addToQuery(e)"
                class="text-sm px-2.5 py-1 rounded-lg hover:opacity-80"
                [style.backgroundColor]="isInQuery(e.uri) ? getTypeConfig(e.type)?.color : getTypeConfig(e.type)?.bg"
                [style.color]="isInQuery(e.uri) ? 'white' : getTypeConfig(e.type)?.color">
                {{ getTypeConfig(e.type)?.icon }} {{ e.label }}
              </button>
            </div>
            
            <p *ngIf="relatedEntities.length === 0" class="text-slate-500">
              No related diseases found
            </p>
          </div>
        </div>
      </div>

      <!-- EIOS Articles Results -->
      <div
        *ngIf="query.length > 0"
        class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
        
        <div class="px-4 py-3 border-b border-slate-700 flex justify-between items-center">
          <h2 class="font-bold">üì∞ EIOS Articles</h2>
          <span class="text-sm text-emerald-400">{{ queryResults.length }} found</span>
        </div>

        <!-- Articles List -->
        <div *ngIf="queryResults.length > 0" class="divide-y divide-slate-700/50 max-h-96 overflow-y-auto">
          <div
            *ngFor="let article of queryResults; trackBy: trackById"
            class="p-4 hover:bg-slate-700/30 transition">
            
            <h3 class="font-medium text-white leading-tight mb-2">{{ article.title }}</h3>
            
            <div class="flex items-center gap-3 text-xs text-slate-400 mb-3">
              <span class="flex items-center gap-1">üì° {{ article.source }}</span>
              <span class="flex items-center gap-1">üìÖ {{ article.date }}</span>
            </div>
            
            <div class="flex flex-wrap gap-1">
              <ng-container *ngFor="let uri of article.entities">
                <button
                  *ngIf="getArticleEntity(uri) as entity"
                  (click)="addToQuery(entity)"
                  class="text-xs px-2 py-0.5 rounded-full transition"
                  [style.backgroundColor]="isInQuery(uri) ? typeConfig[entity.type]?.color : typeConfig[entity.type]?.bg"
                  [style.color]="isInQuery(uri) ? 'white' : typeConfig[entity.type]?.color"
                  [style.opacity]="isInQuery(uri) ? 1 : 0.8">
                  {{ entity.label }}
                </button>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- No Results -->
        <div *ngIf="queryResults.length === 0" class="p-8 text-center">
          <div class="text-3xl mb-2">üîç</div>
          <p class="text-slate-400">No articles found for this combination</p>
          <p class="text-slate-500 text-sm mt-1">Try removing some filters</p>
        </div>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="query.length === 0 && !selected"
        class="bg-slate-800/30 rounded-xl border border-slate-700 p-8 text-center">
        <div class="text-4xl mb-3">üîç</div>
        <h3 class="text-lg font-bold mb-2">Select an entity</h3>
        <p class="text-slate-400 text-sm">Search or click from the sidebar to build your query</p>
      </div>
    </div>
  </main>
</div>
